<!-- This is a modified version of: https://github.com/cgreenhalgh/soundslice-demo/blob/master/public/index.html/  -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Soundslice test</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
<div>
  <div>
    <select id="midiin">
      <option value="">(no MIDI>)</option>
    </select>
    <input type="button" value="start" onclick="handlestart()">

  </div>
  <div>
    <!-- Test slices -->
    <!-- TODO Enable auto-scroll by default. Review SoundSlice iframe parameters https://www.soundslice.com/help/player-api/ -->
    <iframe id="ssembed" src="https://www.soundslice.com/slices/-zgVc/embed/?api=1" width="100%" height="500" frameBorder="0" allowfullscreen></iframe>
  </div>
</div>

<script type="text/javascript">
var ssiframe = document.getElementById('ssembed').contentWindow;
var midiin = document.getElementById("midiin");
var midiinputs = {};

function load() {
  console.log("load event detected!");
  navigator.requestMIDIAccess()
  .then(function(access) {
     // Get lists of available MIDI controllers
     const inputs = access.inputs.values();
     for (let input of inputs) {
       console.log('MIDI input:', input);
       var option = document.createElement("option");
       option.text = input.name;
       option.setAttribute('value', input.id);
       midiin.add(option);
       midiinputs[input.id] = input;
     }
  });
}
window.onload = load;

function handlestart() {

  var midiid = midiin.options[midiin.selectedIndex].value;
  if ( ! midiid ) {
    alert('Please select MIDI input');
    return;
  }
  console.log('use MIDI input '+midiid);
  midiinputs[midiid].onmidimessage = handleMidiMessage;
}

//from https://stackoverflow.com/questions/40902864/how-to-parse-web-midi-api-input-messages-onmidimessage
/**
 * Parse basic information out of a MIDI message.
 */
function parseMidiMessage(message) {
  return {
    command: message.data[0] >> 4,
    channel: message.data[0] & 0xf,
    note: message.data[1],
    velocity: message.data[2] / 127
  }
}
function handleMidiMessage(message) {

  // Parse the MIDIMessageEvent.
  const {command, channel, note, velocity} = parseMidiMessage(message)
  console.log('midi message', message);
  if (command === 11) {
    // CC 0 Bank Select: https://www.midi.org/specifications-old/item/table-3-control-change-messages-data-bytes-2
    // https://github.com/djipco/webmidi/blob/master/src/webmidi.js
    if (note === 0){
      handlePlay();
    }

    if (note === 1) {
      handlePause();
    }

    if (note === 2) {
      handleLoop();
    }

    if (note === 3) {
      handleForward();
      // handleTest();
    }

    if (note === 4) {
      handleSeek();
    }

    if (note === 5) {
      handleSpeed100();
    }

    if (note === 6) {
      handleSpeed75();
    }

    if (note === 7) {
      handleSpeed50();
    }

    if (note === 8) {
      handleSpeed25();
    }
  }
}

function handlePlay() {
  console.log('play');
  ssiframe.postMessage('{"method": "play"}', 'https://www.soundslice.com');
}

function handlePause() {
  console.log('pause');
  ssiframe.postMessage('{"method": "pause"}', 'https://www.soundslice.com');
}
function handleLoop() {
  console.log('set loop');
  window.addEventListener('message', function(event){
    var cmd = JSON.parse(event.data);
    if (cmd.method === "ssCurrentTime"){
      var loopStart = cmd.arg;
    }
    if (cmd.method === "ssDuration"){
      var loopEnd = cmd.arg;
    }
    ssiframe.postMessage(JSON.stringify({"method": "setLoop", "arg": [loopStart, loopEnd]}), 'https://www.soundslice.com');
  });

  ssiframe.postMessage('{"method": "getCurrentTime"}', 'https://www.soundslice.com');
  ssiframe.postMessage('{"method": "getDuration"}', 'https://www.soundslice.com');
}

function handleForward() {
  console.log('forward');
  // Handle inbound current time messages.
  window.addEventListener('message', function(event) {
    var cmd = JSON.parse(event.data);
    ssiframe.postMessage(JSON.stringify({"method": "seek", "arg": cmd.arg + 1}), 'https://www.soundslice.com');

  });
  ssiframe.postMessage('{"method": "getCurrentTime"}', 'https://www.soundslice.com');

}

function handleSeek() {
  console.log('forward');
  // Seek to timecode 3.5 seconds - TODO: ssCurrentTime + 1
  ssiframe.postMessage('{"method": "seek", "arg": 3.5}', 'https://www.soundslice.com');
}

function handleSpeed100() {
  console.log('speed: 100');
  ssiframe.postMessage('{"method": "setSpeed", "arg": 1}', 'https://www.soundslice.com');
}

function handleSpeed75() {
  console.log('speed: 75');
  ssiframe.postMessage('{"method": "setSpeed", "arg": 0.75}', 'https://www.soundslice.com');
}

function handleSpeed50() {
  console.log('speed: 50');
  ssiframe.postMessage('{"method": "setSpeed", "arg": 0.5}', 'https://www.soundslice.com');
}

function handleSpeed25() {
  console.log('speed: 25');
  ssiframe.postMessage('{"method": "setSpeed", "arg": 0.25}', 'https://www.soundslice.com');
}


</script>
  </body>
</html>
